{"version":3,"sources":["..\\..\\..\\..\\..\\assets\\scripts\\utils/assets\\scripts\\utils\\Socket.js"],"names":["window","io","Global","cc","Class","extends","Component","statics","ip","sio","isPinging","fnDisconnect","timeId","handlers","online","addHandler","event","fn","handler","data","JSON","parse","on","connect","fnConnect","fnError","self","opts","isReconnext","connected","vv","gameNetMgr","dispatchEvent","uitools","ShowAlert","director","getScene","sys","isNative","loadScene","parent","location","href","key","value","startHearbeat","lastRecieveTime","Date","now","delayMS","lastSendTime","game","EVENT_HIDE","ping","setInterval","bind","close","send","stringify","emit","isonline","disconnect"],"mappings":"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","file":"Socket.js","sourceRoot":"..\\..\\..\\..\\..\\assets\\scripts\\utils","sourcesContent":["if(window.io == null){\r\n   // window.io = require(\"socket-io\");\r\n}\r\n\r\n\r\nvar Global = cc.Class({\r\n    extends: cc.Component,\r\n\r\n    statics:{\r\n        ip:\"\",\r\n        sio:null,\r\n        isPinging:false,\r\n        fnDisconnect:null,\r\n        timeId:null,\r\n        handlers:{},\r\n        online:true,\r\n        addHandler:function(event,fn){\r\n            if(this.handlers[event]){\r\n                return;\r\n            }\r\n            var handler = function(data){\r\n                if(event != \"disconnect\" && typeof(data)==\"string\"){\r\n                    //console.log(\"Socket:\"+data)\r\n                    data = JSON.parse(data);\r\n                }\r\n                fn(data);\r\n            };\r\n            this.handlers[event] = handler;\r\n            if(this.sio){\r\n                this.sio.on(event,handler);\r\n            }\r\n        },\r\n\r\n        connect:function(fnConnect,fnError){\r\n            var self = this;\r\n            var opts = {\r\n                'reconnect':true,\r\n                'reconnectionAttempts':10,\r\n                'reconnectionDelay':1000,\r\n                'reconnectionDelayMax':2000,\r\n                'timeout':5000,\r\n                'force new connection': true,\r\n                'max reconnection attempts':10,\r\n                'transports':['websocket', 'polling']\r\n            }\r\n            var isReconnext=false;\r\n            this.sio = window.io.connect(this.ip,opts);\r\n            this.sio.on('connecting',function(data){\r\n            });\r\n            this.sio.on('connect',function(data){\r\n                self.sio.connected = true;\r\n                cc.vv.gameNetMgr.dispatchEvent('show_tips_message',null);\r\n                if(isReconnext){\r\n                    cc.vv.gameNetMgr.dispatchEvent('reconnect_update',null);\r\n                }\r\n            });\r\n            this.sio.on('reconnecting',function(data){\r\n                cc.vv.gameNetMgr.dispatchEvent('show_tips_message',\"正在重连\");\r\n            });\r\n            this.sio.on('reconnect',function(data){\r\n                cc.vv.gameNetMgr.dispatchEvent('show_tips_message',\"重连成功\");\r\n                isReconnext = true;\r\n            });\r\n            this.sio.on('connect_error',function(data){\r\n                cc.vv.gameNetMgr.dispatchEvent('show_tips_message',\"重连失败\");\r\n            });\r\n            this.sio.on('disconnect',function(data){\r\n                self.sio.connected = false;\r\n                cc.vv.gameNetMgr.dispatchEvent('show_tips_message',\"已断开连接，请重进\");\r\n            });\r\n            this.sio.on('reconnect_failed',function(data){\r\n                cc.vv.gameNetMgr.dispatchEvent('show_tips_message',\"重连失败，请重进\");\r\n                cc.vv.uitools.ShowAlert(cc.director.getScene(),\"你已断开连接,请重新连接\",function(){\r\n                    if(cc.sys.isNative){\r\n                        cc.director.loadScene(\"web\");\r\n                    }else{\r\n                        window.parent.location.href=\"/\";\r\n                    }\r\n                },false);\r\n            });\r\n            this.sio.on('connect_failed',function (){\r\n                cc.vv.gameNetMgr.dispatchEvent('show_tips_message',\"连接失败\");\r\n                isReconnext = true;\r\n            });\r\n\r\n            for(var key in this.handlers){\r\n                var value = this.handlers[key];\r\n                if(typeof(value) == \"function\"){\r\n                    if(key == 'disconnect'){\r\n                        this.fnDisconnect = value;\r\n                    }else{\r\n                        this.sio.on(key,value);                        \r\n                    }\r\n                }\r\n            }\r\n        },\r\n\r\n\r\n        startHearbeat:function(){\r\n            this.sio.on('game_pong',function(data){\r\n                self.lastRecieveTime = Date.now();\r\n                self.delayMS = self.lastRecieveTime - self.lastSendTime;\r\n                if(self.online==false){\r\n                    cc.vv.gameNetMgr.dispatchEvent('show_tips_message',null);\r\n                    cc.vv.gameNetMgr.dispatchEvent('reconnect_update',null);\r\n                }\r\n                self.online = true;\r\n            });\r\n            this.lastRecieveTime = Date.now();\r\n            var self = this;\r\n            if(!self.isPinging){\r\n                self.isPinging = true;\r\n                cc.game.on(cc.game.EVENT_HIDE,function(){\r\n                    self.ping();\r\n                });\r\n                setInterval(function(){\r\n                    if(self.sio){\r\n                        self.ping();                \r\n                    }\r\n                }.bind(this),5000);\r\n                setInterval(function(){\r\n                    if(self.sio){\r\n                        if(Date.now() - self.lastRecieveTime > 20000){\r\n                            self.close();\r\n                        }         \r\n                    }\r\n                }.bind(this),500);\r\n            } \r\n        },\r\n\r\n        send:function(event,data){\r\n            if(this.sio && this.sio.connected){\r\n                if(data != null && (typeof(data) == \"object\")){\r\n                    data = JSON.stringify(data);\r\n                }\r\n                this.sio.emit(event,data);                \r\n            }\r\n        },\r\n        ping:function(){\r\n            if(this.sio){\r\n                var isonline = this.online;\r\n                this.lastSendTime = Date.now();\r\n                this.send('game_ping',{isonline:isonline});\r\n            }\r\n        },\r\n        \r\n        close:function(){\r\n            this.delayMS = null;\r\n            if(this.sio && this.sio.connected){\r\n                this.sio.connected = false;\r\n                this.sio.disconnect();\r\n                this.sio = null;\r\n            }\r\n            this.sio = null;\r\n        },\r\n\r\n    },\r\n});\r\n"]}